###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.3.40338/W32 for 8051         21/Jul/2014  12:20:04 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\Source\MT_TASK.c         #
#    Command line       =  -f D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\P #
#                          rojects\zstack\Utilities\OAD\CC2530DB\..\..\..\Too #
#                          ls\CC2530DB\f8wEndev.cfg (-DCPU32MHZ               #
#                          -DROOT=__near_func -DBLINK_LEDS) -f                #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\Tools\ #
#                          CC2530DB\f8wConfig.cfg (-DSECURE=0                 #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFF0                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116 "-DCONST=const __code"    #
#                          -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE     #
#                          -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100            #
#                          -DRESPONSE_POLL_RATE=100) -DREJOIN_POLL_RATE=440   #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\Source\MT_TASK.c -D      #
#                          NWK_AUTO_POLL -D ZTOOL_P1 -D MT_TASK -D            #
#                          MT_APP_FUNC -D MT_NWK_FUNC -D MT_NWK_CB_FUNC -D    #
#                          MT_SYS_FUNC -D MT_ZDO_FUNC -D MT_ZDO_CB_FUNC -D    #
#                          MT_UTIL_FUNC -D LCD_SUPPORTED -D                   #
#                          RFD_RCVC_ALWAYS_ON -D ZPORT -D HOLD_AUTO_START     #
#                          -lC D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\ #
#                          Projects\zstack\Utilities\OAD\CC2530DB\DongleEB\Li #
#                          st\ -lA D:\WorkReserve\project\AES_BOOT\CC2530EncB #
#                          oot\Projects\zstack\Utilities\OAD\CC2530DB\DongleE #
#                          B\List\ -o D:\WorkReserve\project\AES_BOOT\CC2530E #
#                          ncBoot\Projects\zstack\Utilities\OAD\CC2530DB\Dong #
#                          leEB\Obj\ -e --debug --core=plain --dptr=16,1      #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\P #
#                          rojects\zstack\Utilities\OAD\CC2530DB\ -I          #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\SOURCE\ -I   #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\ZMAIN\ #
#                          TI2530DB\ -I D:\WorkReserve\project\AES_BOOT\CC253 #
#                          0EncBoot\Projects\zstack\Utilities\OAD\CC2530DB\.. #
#                          \..\..\..\..\COMPONENTS\MT\ -I                     #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\HAL\INCLUDE\ -I                         #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\HAL\TARGET\CC2530EB\ -I                 #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\OSAL\INCLUDE\ -I                        #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\STACK\AF\ -I D:\WorkReserve\project\AES #
#                          _BOOT\CC2530EncBoot\Projects\zstack\Utilities\OAD\ #
#                          CC2530DB\..\..\..\..\..\COMPONENTS\STACK\NWK\ -I   #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\STACK\SEC\ -I                           #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\STACK\SAPI\ -I                          #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\STACK\SYS\ -I                           #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\STACK\ZDO\ -I                           #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\ZMAC\F8W\ -I D:\WorkReserve\project\AES #
#                          _BOOT\CC2530EncBoot\Projects\zstack\Utilities\OAD\ #
#                          CC2530DB\..\..\..\..\..\COMPONENTS\ZMAC\ -I        #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\SERVICES\SADDR\ -I                      #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\SERVICES\SDATA\ -I                      #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\MAC\INCLUDE\ -I                         #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\MAC\HIGH_LEVEL\ -I                      #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\MAC\LOW_LEVEL\srf04\ -I                 #
#                          D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\MAC\LOW_LEVEL\srf04\SINGLE_CHIP\ -Ohz   #
#                          --require_prototypes                               #
#    List file          =  D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\DongleEB\List\M #
#                          T_TASK.lst                                         #
#    Object file        =  D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Proj #
#                          ects\zstack\Utilities\OAD\CC2530DB\DongleEB\Obj\MT #
#                          _TASK.r51                                          #
#                                                                             #
#                                                                             #
###############################################################################

D:\WorkReserve\project\AES_BOOT\CC2530EncBoot\Projects\zstack\Utilities\OAD\Source\MT_TASK.c
      1          /***************************************************************************************************
      2            Filename:       MT_TASK.c
      3            Revised:        $Date: 2008-03-14 12:54:09 -0700 (Fri, 14 Mar 2008) $
      4            Revision:       $Revision: 16592 $
      5          
      6            Description:    MonitorTest Task handling routines
      7          
      8            Copyright 2007 Texas Instruments Incorporated. All rights reserved.
      9          
     10            IMPORTANT: Your use of this Software is limited to those specific rights
     11            granted under the terms of a software license agreement between the user
     12            who downloaded the software, his/her employer (which must be your employer)
     13            and Texas Instruments Incorporated (the "License").  You may not use this
     14            Software unless you agree to abide by the terms of the License. The License
     15            limits your use, and you acknowledge, that the Software may not be modified,
     16            copied or distributed unless embedded on a Texas Instruments microcontroller
     17            or used solely and exclusively in conjunction with a Texas Instruments radio
     18            frequency transceiver, which is integrated into your product.  Other than for
     19            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     20            works of, modify, distribute, perform, display or sell this Software and/or
     21            its documentation for any purpose.
     22          
     23            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     24            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     25            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     26            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     27            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     28            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     29            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     30            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     31            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     32            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     33            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     34          
     35            Should you have any questions regarding your right to use this Software,
     36            contact Texas Instruments Incorporated at www.TI.com.
     37          
     38           ***************************************************************************************************/
     39          
     40          /***************************************************************************************************
     41           * INCLUDES
     42           ***************************************************************************************************/
     43          #include "ZComDef.h"
     44          #include "MT_TASK.h"
     45          #include "MT.h"
     46          #include "MT_DEBUG.h"
     47          #include "MT_UART.h"
     48          #include "MT_SYS.h"
     49          #include "mt_x.h"
     50          
     51          #include "hal_uart.h"
     52          
     53          #include "OSAL_Memory.h"
     54          
     55          /***************************************************************************************************
     56           * LOCAL FUNCTIONS
     57           ***************************************************************************************************/
     58          void MT_ProcessIncomingCommand( mtOSALSerialData_t *msg );
     59          
     60          /***************************************************************************************************
     61           * GLOBALS
     62           ***************************************************************************************************/
     63          
     64          /***************************************************************************************************
     65           * @fn      MT_TaskInit
     66           *
     67           * @brief  MonitorTest Task Initialization.  This function is put into the
     68           *         task table.
     69           *
     70           * @param   byte task_id - task ID of the MT Task
     71           *
     72           * @return  void
     73           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     74          void MT_TaskInit(uint8 task_id)
   \                     MT_TaskInit:
     75          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
     76            /* Initialize MT */
     77            MT_Init(task_id);
   \   000007                ; Setup parameters for call to function MT_Init
   \   000007   12....       LCALL   ??MT_Init?relay
     78          
     79            /* Initialize the Serial port */
     80            MT_UartInit();
   \   00000A                ; Setup parameters for call to function MT_UartInit
   \   00000A   12....       LCALL   ??MT_UartInit?relay
     81          
     82            /* Register taskID - Do this after UartInit() because it will reset the taskID */
     83            MT_UartRegisterTaskID (task_id);
   \   00000D                ; Setup parameters for call to function MT_UartRegisterTaskID
   \   00000D   EE           MOV     A,R6
   \   00000E   F9           MOV     R1,A
   \   00000F   12....       LCALL   ??MT_UartRegisterTaskID?relay
     84          } /* MT_TaskInit() */
   \   000012   7F01         MOV     R7,#0x1
   \   000014   02....       LJMP    ?BANKED_LEAVE_XDATA
     85          
     86          /***************************************************************************************************
     87           * @fn      MT_ProcessEvent
     88           *
     89           * @brief MonitorTest Task Event Processor.  This task is put into the task table.
     90           *
     91           * @param   byte task_id - task ID of the MT Task
     92           * @param   UINT16 events - event(s) for the MT Task
     93           *
     94           * @return  void
     95           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     96          UINT16 MT_ProcessEvent(uint8 task_id, uint16 events)
   \                     MT_ProcessEvent:
     97          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
     98            uint8 *msg_ptr;
     99            (void)task_id;
    100            
    101            /* Could be multiple events, so switch won't work */
    102            if ( events & SYS_EVENT_MSG )
   \   000009   5480         ANL     A,#0x80
   \   00000B   700E         JNZ     ??MT_ProcessEvent_0
    103            {
    104              while ( (msg_ptr = osal_msg_receive( MT_TaskID )) )
    105              {
    106                MT_ProcessIncomingCommand((mtOSALSerialData_t *)msg_ptr);
    107              }
    108          
    109              /* Return unproccessed events */
    110              return (events ^ SYS_EVENT_MSG);
    111            }
    112          
    113            if ( events & MT_ZTOOL_SERIAL_RCV_BUFFER_FULL )
   \   00000D   EE           MOV     A,R6
   \   00000E   5404         ANL     A,#0x4
   \   000010   601D         JZ      ??MT_ProcessEvent_1
    114            {
    115              /* Return unproccessed events */
    116              return (events ^ MT_ZTOOL_SERIAL_RCV_BUFFER_FULL);
   \   000012   EE           MOV     A,R6
   \   000013   6404         XRL     A,#0x4
   \   000015   FA           MOV     R2,A
   \   000016   805D         SJMP    ??MT_ProcessEvent_2
    117            }
   \                     ??MT_ProcessEvent_3:
   \   000018                ; Setup parameters for call to function MT_ProcessIncomingCommand
   \   000018   12....       LCALL   ??MT_ProcessIncomingCommand?relay
   \                     ??MT_ProcessEvent_0:
   \   00001B                ; Setup parameters for call to function osal_msg_receive
   \   00001B   90....       MOV     DPTR,#MT_TaskID
   \   00001E   E0           MOVX    A,@DPTR
   \   00001F   F9           MOV     R1,A
   \   000020   12....       LCALL   ??osal_msg_receive?relay
   \   000023   EA           MOV     A,R2
   \   000024   4B           ORL     A,R3
   \   000025   70F1         JNZ     ??MT_ProcessEvent_3
   \   000027   EE           MOV     A,R6
   \   000028   FA           MOV     R2,A
   \   000029   EF           MOV     A,R7
   \   00002A   6480         XRL     A,#0x80
   \                     ??MT_ProcessEvent_4:
   \   00002C   FB           MOV     R3,A
   \   00002D   8046         SJMP    ??MT_ProcessEvent_2
    118          
    119            /* Handle MT_SYS_OSAL_START_TIMER callbacks */
    120          #if defined MT_SYS_FUNC
    121            if ( events & (MT_SYS_OSAL_EVENT_MASK))
   \                     ??MT_ProcessEvent_1:
   \   00002F   EF           MOV     A,R7
   \   000030   540F         ANL     A,#0xf
   \   000032   603D         JZ      ??MT_ProcessEvent_5
    122            {
    123              if (events & MT_SYS_OSAL_EVENT_0)
   \   000034   EF           MOV     A,R7
   \   000035   5408         ANL     A,#0x8
   \   000037   6009         JZ      ??MT_ProcessEvent_6
    124              {
    125                MT_SysOsalTimerExpired(0x00);
   \   000039                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   000039   7900         MOV     R1,#0x0
   \   00003B   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    126                events ^= MT_SYS_OSAL_EVENT_0;
   \   00003E   7408         MOV     A,#0x8
   \   000040   6F           XRL     A,R7
   \   000041   FF           MOV     R7,A
    127              }
    128          
    129              if (events & MT_SYS_OSAL_EVENT_1)
   \                     ??MT_ProcessEvent_6:
   \   000042   EF           MOV     A,R7
   \   000043   5404         ANL     A,#0x4
   \   000045   6009         JZ      ??MT_ProcessEvent_7
    130              {
    131                MT_SysOsalTimerExpired(0x01);
   \   000047                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   000047   7901         MOV     R1,#0x1
   \   000049   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    132                events ^= MT_SYS_OSAL_EVENT_1;
   \   00004C   7404         MOV     A,#0x4
   \   00004E   6F           XRL     A,R7
   \   00004F   FF           MOV     R7,A
    133              }
    134          
    135              if (events & MT_SYS_OSAL_EVENT_2)
   \                     ??MT_ProcessEvent_7:
   \   000050   EF           MOV     A,R7
   \   000051   5402         ANL     A,#0x2
   \   000053   6009         JZ      ??MT_ProcessEvent_8
    136              {
    137                MT_SysOsalTimerExpired(0x02);
   \   000055                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   000055   7902         MOV     R1,#0x2
   \   000057   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    138                events ^= MT_SYS_OSAL_EVENT_2;
   \   00005A   7402         MOV     A,#0x2
   \   00005C   6F           XRL     A,R7
   \   00005D   FF           MOV     R7,A
    139              }
    140          
    141              if (events & MT_SYS_OSAL_EVENT_3)
   \                     ??MT_ProcessEvent_8:
   \   00005E   EF           MOV     A,R7
   \   00005F   5401         ANL     A,#0x1
   \   000061   6009         JZ      ??MT_ProcessEvent_9
    142              {
    143                MT_SysOsalTimerExpired(0x03);
   \   000063                ; Setup parameters for call to function MT_SysOsalTimerExpired
   \   000063   7903         MOV     R1,#0x3
   \   000065   12....       LCALL   ??MT_SysOsalTimerExpired?relay
    144                events ^= MT_SYS_OSAL_EVENT_3;
   \   000068   7401         MOV     A,#0x1
   \   00006A   6F           XRL     A,R7
   \   00006B   FF           MOV     R7,A
    145              }
    146          
    147              return events;
   \                     ??MT_ProcessEvent_9:
   \   00006C   EE           MOV     A,R6
   \   00006D   FA           MOV     R2,A
   \   00006E   EF           MOV     A,R7
   \   00006F   80BB         SJMP    ??MT_ProcessEvent_4
    148            }
    149          #endif
    150          
    151            /* Discard or make more handlers */
    152            return 0;
   \                     ??MT_ProcessEvent_5:
   \   000071   7A00         MOV     R2,#0x0
   \   000073   7B00         MOV     R3,#0x0
   \                     ??MT_ProcessEvent_2:
   \   000075                REQUIRE ?Subroutine0
   \   000075                ; // Fall through to label ?Subroutine0
    153          
    154          } /* MT_ProcessEvent() */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   7F02         MOV     R7,#0x2
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA
    155          
    156          /***************************************************************************************************
    157           * @fn      MT_ProcessIncomingCommand
    158           *
    159           * @brief
    160           *
    161           *   Process Event Messages.
    162           *
    163           * @param   byte *msg - pointer to event message
    164           *
    165           * @return
    166           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    167          void MT_ProcessIncomingCommand( mtOSALSerialData_t *msg )
   \                     MT_ProcessIncomingCommand:
    168          {
   \   000000   74F3         MOV     A,#-0xd
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 13
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
    169            byte deallocate;
    170            byte *msg_ptr;
    171            byte len;
    172          
    173            /* A little setup for AF, CB_FUNC and MT_SYS_APP_RSP_MSG */
    174            msg_ptr = msg->msg;
   \   000009   8E82         MOV     DPL,R6
   \   00000B   8F83         MOV     DPH,R7
   \   00000D   A3           INC     DPTR
   \   00000E   A3           INC     DPTR
   \   00000F   E0           MOVX    A,@DPTR
   \   000010   FA           MOV     R2,A
   \   000011   A3           INC     DPTR
   \   000012   E0           MOVX    A,@DPTR
   \   000013   FB           MOV     R3,A
   \   000014   8A..         MOV     ?V0 + 0,R2
   \   000016   8B..         MOV     ?V0 + 1,R3
    175          
    176            deallocate = true;
    177          
    178            /* Use the first byte of the message as the command ID */
    179            switch ( msg->hdr.event )
   \   000018   EA           MOV     A,R2
   \   000019   2403         ADD     A,#0x3
   \   00001B   F8           MOV     R0,A
   \   00001C   EB           MOV     A,R3
   \   00001D   3400         ADDC    A,#0x0
   \   00001F   F9           MOV     R1,A
   \   000020   8E82         MOV     DPL,R6
   \   000022   8F83         MOV     DPH,R7
   \   000024   E0           MOVX    A,@DPTR
   \   000025   14           DEC     A
   \   000026   6011         JZ      ??MT_ProcessIncomingCommand_0
   \   000028   14           DEC     A
   \   000029   6013         JZ      ??MT_ProcessIncomingCommand_1
   \   00002B   24FE         ADD     A,#-0x2
   \   00002D   6021         JZ      ??MT_ProcessIncomingCommand_2
   \   00002F   24FE         ADD     A,#-0x2
   \   000031   6014         JZ      ??MT_ProcessIncomingCommand_3
   \   000033   24E2         ADD     A,#-0x1e
   \   000035   605F         JZ      ??MT_ProcessIncomingCommand_4
   \   000037   8068         SJMP    ??MT_ProcessIncomingCommand_5
    180            {
    181              case CMD_SERIAL_MSG:
    182                MT_ProcessIncoming(msg->msg);
   \                     ??MT_ProcessIncomingCommand_0:
   \   000039                ; Setup parameters for call to function MT_ProcessIncoming
   \   000039   12....       LCALL   ??MT_ProcessIncoming?relay
    183                break;
   \   00003C   8063         SJMP    ??MT_ProcessIncomingCommand_5
    184          
    185              case CMD_DEBUG_MSG:
    186                MT_ProcessDebugMsg( (mtDebugMsg_t *)msg );
   \                     ??MT_ProcessIncomingCommand_1:
   \   00003E                ; Setup parameters for call to function MT_ProcessDebugMsg
   \   00003E   EE           MOV     A,R6
   \   00003F   FA           MOV     R2,A
   \   000040   EF           MOV     A,R7
   \   000041   FB           MOV     R3,A
   \   000042   12....       LCALL   ??MT_ProcessDebugMsg?relay
    187                break;
   \   000045   805A         SJMP    ??MT_ProcessIncomingCommand_5
    188          
    189              case CMD_DEBUG_STR:
    190                MT_ProcessDebugStr( (mtDebugStr_t *)msg );
   \                     ??MT_ProcessIncomingCommand_3:
   \   000047                ; Setup parameters for call to function MT_ProcessDebugStr
   \   000047   EE           MOV     A,R6
   \   000048   FA           MOV     R2,A
   \   000049   EF           MOV     A,R7
   \   00004A   FB           MOV     R3,A
   \   00004B   12....       LCALL   ??MT_ProcessDebugStr?relay
    191                break;
   \   00004E   8051         SJMP    ??MT_ProcessIncomingCommand_5
    192          
    193              case CB_FUNC:
    194                /*
    195                  Build SPI message here instead of redundantly calling MT_BuildSPIMsg
    196                  because we have copied data already in the allocated message
    197                */
    198          
    199                /* msg_ptr is the beginning of the intended SPI message */
    200                len = SPI_0DATA_MSG_LEN + msg_ptr[DATALEN_FIELD];
   \                     ??MT_ProcessIncomingCommand_2:
   \   000050   8882         MOV     DPL,R0
   \   000052   8983         MOV     DPH,R1
   \   000054   E0           MOVX    A,@DPTR
   \   000055   2405         ADD     A,#0x5
   \   000057   F5..         MOV     ?V0 + 4,A
    201          
    202                /*
    203                  FCS goes to the last byte in the message and is calculated over all
    204                  the bytes except FCS and SOP
    205                */
    206                msg_ptr[len-1] = MT_UartCalcFCS(msg_ptr + 1, (byte)(len-2));
   \   000059                ; Setup parameters for call to function MT_UartCalcFCS
   \   000059   74FE         MOV     A,#-0x2
   \   00005B   25..         ADD     A,?V0 + 4
   \   00005D   F9           MOV     R1,A
   \   00005E   8A82         MOV     DPL,R2
   \   000060   8B83         MOV     DPH,R3
   \   000062   A3           INC     DPTR
   \   000063   AA82         MOV     R2,DPL
   \   000065   AB83         MOV     R3,DPH
   \   000067   12....       LCALL   ??MT_UartCalcFCS?relay
   \   00006A   E9           MOV     A,R1
   \   00006B   C0E0         PUSH    A
   \   00006D   85....       MOV     ?V0 + 2,?V0 + 4
   \   000070   E5..         MOV     A,?V0 + 0
   \   000072   25..         ADD     A,?V0 + 2
   \   000074   F8           MOV     R0,A
   \   000075   E5..         MOV     A,?V0 + 1
   \   000077   3400         ADDC    A,#0x0
   \   000079   F9           MOV     R1,A
   \   00007A   E8           MOV     A,R0
   \   00007B   24FF         ADD     A,#-0x1
   \   00007D   F582         MOV     DPL,A
   \   00007F   E9           MOV     A,R1
   \   000080   34FF         ADDC    A,#-0x1
   \   000082   F583         MOV     DPH,A
   \   000084   D0E0         POP     A
   \   000086   F0           MOVX    @DPTR,A
    207          
    208          #ifdef MT_UART_DEFAULT_PORT
    209                HalUARTWrite ( MT_UART_DEFAULT_PORT, msg_ptr, len );
   \   000087                ; Setup parameters for call to function HalUARTWrite
   \   000087   AC..         MOV     R4,?V0 + 2
   \   000089   7D00         MOV     R5,#0x0
   \   00008B   AA..         MOV     R2,?V0 + 0
   \   00008D   AB..         MOV     R3,?V0 + 1
   \   00008F   7900         MOV     R1,#0x0
   \   000091   12....       LCALL   ??HalUARTWrite?relay
    210          #endif
    211                break;
   \   000094   800B         SJMP    ??MT_ProcessIncomingCommand_5
    212          
    213          #if !defined ( NONWK )
    214              case MT_SYS_APP_RSP_MSG:
    215                len = SPI_0DATA_MSG_LEN + msg_ptr[DATALEN_FIELD];
    216                MTProcessAppRspMsg( msg_ptr, len );
   \                     ??MT_ProcessIncomingCommand_4:
   \   000096                ; Setup parameters for call to function MTProcessAppRspMsg
   \   000096   8882         MOV     DPL,R0
   \   000098   8983         MOV     DPH,R1
   \   00009A   E0           MOVX    A,@DPTR
   \   00009B   2405         ADD     A,#0x5
   \   00009D   F9           MOV     R1,A
   \   00009E   12....       LCALL   ??MTProcessAppRspMsg?relay
    217                break;
    218          #endif  // NONWK
    219          
    220              default:
    221                break;
    222            }
    223          
    224            if ( deallocate )
    225            {
    226              osal_msg_deallocate( (uint8 *)msg );
   \                     ??MT_ProcessIncomingCommand_5:
   \   0000A1                ; Setup parameters for call to function osal_msg_deallocate
   \   0000A1   EE           MOV     A,R6
   \   0000A2   FA           MOV     R2,A
   \   0000A3   EF           MOV     A,R7
   \   0000A4   FB           MOV     R3,A
   \   0000A5   12....       LCALL   ??osal_msg_deallocate?relay
    227            }
    228          }
   \   0000A8   7F05         MOV     R7,#0x5
   \   0000AA   02....       LJMP    ?BANKED_LEAVE_XDATA
    229          
    230          #ifdef MT_TASK
    231          /***************************************************************************************************
    232           * @fn      MT_TransportAlloc
    233           *
    234           * @brief   Allocate memory for transport msg
    235           *
    236           * @param   uint8 cmd0 - The first byte of the MT command id containing the command type and subsystem.
    237           *          uint8 len - length
    238           *
    239           * @return  pointer the allocated memory or NULL if fail to allocate the memory
    240           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    241          uint8 *MT_TransportAlloc(uint8 cmd0, uint8 len)
   \                     MT_TransportAlloc:
    242          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
    243            uint8 *p;
    244            (void)cmd0;
    245            
    246            /* Allocate a buffer of data length + SOP+CMD+FCS (5bytes) */
    247            p = osal_msg_allocate(len + SPI_0DATA_MSG_LEN);
   \   000006                ; Setup parameters for call to function osal_msg_allocate
   \   000006   2405         ADD     A,#0x5
   \   000008   FA           MOV     R2,A
   \   000009   E4           CLR     A
   \   00000A   3400         ADDC    A,#0x0
   \   00000C   FB           MOV     R3,A
   \   00000D   12....       LCALL   ??osal_msg_allocate?relay
   \   000010   8A82         MOV     DPL,R2
   \   000012   8B83         MOV     DPH,R3
    248          
    249            if (p)
   \   000014   E582         MOV     A,DPL
   \   000016   4583         ORL     A,DPH
   \   000018   6007         JZ      ??MT_TransportAlloc_0
    250            {
    251              p++; /* Save space for SOP_VALUE, msg structure */
    252              return p;
   \   00001A   A3           INC     DPTR
   \   00001B   AA82         MOV     R2,DPL
   \   00001D   AB83         MOV     R3,DPH
   \   00001F   8004         SJMP    ??MT_TransportAlloc_1
    253            }
    254            else
    255            {
    256              return NULL;
   \                     ??MT_TransportAlloc_0:
   \   000021   7A00         MOV     R2,#0x0
   \   000023   7B00         MOV     R3,#0x0
    257            }
   \                     ??MT_TransportAlloc_1:
   \   000025   02....       LJMP    ?Subroutine0 & 0xFFFF
    258          }
    259          
    260          /***************************************************************************************************
    261           * @fn      MT_TransportSend
    262           *
    263           * @brief   Fill in SOP and FCS then send out the msg
    264           *
    265           * @param   uint8 *pBuf - pointer to the message that contains CMD, length, data and FCS
    266           *
    267           * @return  None
    268           ***************************************************************************************************/

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    269          void MT_TransportSend(uint8 *pBuf)
   \                     MT_TransportSend:
    270          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    271            MT_X_TransportSend(pBuf-1);
   \   000004                ; Setup parameters for call to function MT_X_TransportSend
   \   000004   EA           MOV     A,R2
   \   000005   24FF         ADD     A,#-0x1
   \   000007   1A           DEC     R2
   \   000008   EB           MOV     A,R3
   \   000009   34FF         ADDC    A,#-0x1
   \   00000B   FB           MOV     R3,A
   \   00000C   12....       LCALL   ??MT_X_TransportSend?relay
    272          }
   \   00000F   D083         POP     DPH
   \   000011   D082         POP     DPL
   \   000013   02....       LJMP    ?BRET

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_TaskInit?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_TaskInit

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_ProcessEvent?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_ProcessEvent

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_ProcessIncomingCommand?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_ProcessIncomingCommand

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_TransportAlloc?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_TransportAlloc

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??MT_TransportSend?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    MT_TransportSend
    273          #endif /* MT_TASK */
    274          /***************************************************************************************************
    275           ***************************************************************************************************/

   Maximum stack usage in bytes:

     Function                       ISTACK PSTACK XSTACK
     --------                       ------ ------ ------
     MT_ProcessEvent                    0      0     10
       -> MT_ProcessIncomingCommand     0      0     20
       -> osal_msg_receive              0      0     20
       -> MT_SysOsalTimerExpired        0      0     20
       -> MT_SysOsalTimerExpired        0      0     20
       -> MT_SysOsalTimerExpired        0      0     20
       -> MT_SysOsalTimerExpired        0      0     20
     MT_ProcessIncomingCommand          1      0     23
       -> MT_ProcessIncoming            0      0     26
       -> MT_ProcessDebugMsg            0      0     26
       -> MT_ProcessDebugStr            0      0     26
       -> MT_UartCalcFCS                0      0     26
       -> HalUARTWrite                  0      0     26
       -> MTProcessAppRspMsg            0      0     26
       -> osal_msg_deallocate           0      0     26
     MT_TaskInit                        0      0      9
       -> MT_Init                       0      0     18
       -> MT_UartInit                   0      0     18
       -> MT_UartRegisterTaskID         0      0     18
     MT_TransportAlloc                  0      0     10
       -> osal_msg_allocate             0      0     20
     MT_TransportSend                   2      0      0
       -> MT_X_TransportSend            4      0      0


   Segment part sizes:

     Function/Label                    Bytes
     --------------                    -----
     MT_TaskInit                         23
     MT_ProcessEvent                    117
     ?Subroutine0                         5
     MT_ProcessIncomingCommand          173
     MT_TransportAlloc                   40
     MT_TransportSend                    22
     ??MT_TaskInit?relay                  6
     ??MT_ProcessEvent?relay              6
     ??MT_ProcessIncomingCommand?relay    6
     ??MT_TransportAlloc?relay            6
     ??MT_TransportSend?relay             6

 
 380 bytes in segment BANKED_CODE
  30 bytes in segment BANK_RELAYS
 
 410 bytes of CODE memory

Errors: none
Warnings: none
