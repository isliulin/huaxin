###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.3.40338/W32 for 8051         13/Mar/2014  11:14:50 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  D:\WorkReserve\project\NewStep\CanMstOsal\Componen #
#                          ts\mac\low_level\srf04\search_zb_net.c             #
#    Command line       =  -f "D:\WorkReserve\project\NewStep\CanMstOsal\Proj #
#                          ects\zstack\Samples\SampleApp                      #
#                          com\CC2530DB\..\..\..\Tools\CC2530DB\f8wConfig.cfg #
#                          " (-DSECURE=0 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR    #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFF0                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116 "-DCONST=const __code"    #
#                          -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE     #
#                          -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100            #
#                          -DRESPONSE_POLL_RATE=100 -DREJOIN_POLL_RATE=440)   #
#                          D:\WorkReserve\project\NewStep\CanMstOsal\Componen #
#                          ts\mac\low_level\srf04\search_zb_net.c -D          #
#                          ZIGBEEPRO -D ZTOOL_P1 -lC                          #
#                          "D:\WorkReserve\project\NewStep\CanMstOsal\Project #
#                          s\zstack\Samples\SampleApp                         #
#                          com\CC2530DB\CoordinatorEB-Pro\List\" -lA          #
#                          "D:\WorkReserve\project\NewStep\CanMstOsal\Project #
#                          s\zstack\Samples\SampleApp                         #
#                          com\CC2530DB\CoordinatorEB-Pro\List\"              #
#                          --diag_suppress Pe001,Pa010 -o                     #
#                          "D:\WorkReserve\project\NewStep\CanMstOsal\Project #
#                          s\zstack\Samples\SampleApp                         #
#                          com\CC2530DB\CoordinatorEB-Pro\Obj\" -e --debug    #
#                          --core=plain --dptr=16,1 --data_model=large        #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 16 -I "D:\WorkReserve\project\Ne #
#                          wStep\CanMstOsal\Projects\zstack\Samples\SampleApp #
#                           com\CC2530DB\" -I "D:\WorkReserve\project\NewStep #
#                          \CanMstOsal\Projects\zstack\Samples\SampleApp      #
#                          com\CC2530DB\..\SOURCE\" -I                        #
#                          "D:\WorkReserve\project\NewStep\CanMstOsal\Project #
#                          s\zstack\Samples\SampleApp                         #
#                          com\CC2530DB\..\..\..\ZMAIN\TI2530DB\" -I          #
#                          "D:\WorkReserve\project\NewStep\CanMstOsal\Project #
#                          s\zstack\Samples\SampleApp                         #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\MT\" -I     #
#                          "D:\WorkReserve\project\NewStep\CanMstOsal\Project #
#                          s\zstack\Samples\SampleApp                         #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\HAL\INCLUDE #
#                          \" -I "D:\WorkReserve\project\NewStep\CanMstOsal\P #
#                          rojects\zstack\Samples\SampleApp                   #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\HAL\TARGET\ #
#                          CC2530EB\" -I "D:\WorkReserve\project\NewStep\CanM #
#                          stOsal\Projects\zstack\Samples\SampleApp           #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\OSAL\MCU\CC #
#                          SOC\" -I "D:\WorkReserve\project\NewStep\CanMstOsa #
#                          l\Projects\zstack\Samples\SampleApp                #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\OSAL\INCLUD #
#                          E\" -I "D:\WorkReserve\project\NewStep\CanMstOsal\ #
#                          Projects\zstack\Samples\SampleApp                  #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\AF\"  #
#                          -I "D:\WorkReserve\project\NewStep\CanMstOsal\Proj #
#                          ects\zstack\Samples\SampleApp                      #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\NWK\" #
#                           -I "D:\WorkReserve\project\NewStep\CanMstOsal\Pro #
#                          jects\zstack\Samples\SampleApp                     #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SEC\" #
#                           -I "D:\WorkReserve\project\NewStep\CanMstOsal\Pro #
#                          jects\zstack\Samples\SampleApp                     #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SAPI\ #
#                          " -I "D:\WorkReserve\project\NewStep\CanMstOsal\Pr #
#                          ojects\zstack\Samples\SampleApp                    #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\SYS\" #
#                           -I "D:\WorkReserve\project\NewStep\CanMstOsal\Pro #
#                          jects\zstack\Samples\SampleApp                     #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\STACK\ZDO\" #
#                           -I "D:\WorkReserve\project\NewStep\CanMstOsal\Pro #
#                          jects\zstack\Samples\SampleApp                     #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\ZMAC\F8W\"  #
#                          -I "D:\WorkReserve\project\NewStep\CanMstOsal\Proj #
#                          ects\zstack\Samples\SampleApp                      #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\ZMAC\" -I   #
#                          "D:\WorkReserve\project\NewStep\CanMstOsal\Project #
#                          s\zstack\Samples\SampleApp                         #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\SERVICES\SA #
#                          DDR\" -I "D:\WorkReserve\project\NewStep\CanMstOsa #
#                          l\Projects\zstack\Samples\SampleApp                #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\SERVICES\SD #
#                          ATA\" -I "D:\WorkReserve\project\NewStep\CanMstOsa #
#                          l\Projects\zstack\Samples\SampleApp                #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\INCLUDE #
#                          \" -I "D:\WorkReserve\project\NewStep\CanMstOsal\P #
#                          rojects\zstack\Samples\SampleApp                   #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\HIGH_LE #
#                          VEL\" -I "D:\WorkReserve\project\NewStep\CanMstOsa #
#                          l\Projects\zstack\Samples\SampleApp                #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\LOW_LEV #
#                          EL\srf04\" -I "D:\WorkReserve\project\NewStep\CanM #
#                          stOsal\Projects\zstack\Samples\SampleApp           #
#                          com\CC2530DB\..\..\..\..\..\COMPONENTS\MAC\LOW_LEV #
#                          EL\srf04\SINGLE_CHIP\" -Ohz --require_prototypes   #
#    List file          =  D:\WorkReserve\project\NewStep\CanMstOsal\Projects #
#                          \zstack\Samples\SampleApp                          #
#                          com\CC2530DB\CoordinatorEB-Pro\List\search_zb_net. #
#                          lst                                                #
#    Object file        =  D:\WorkReserve\project\NewStep\CanMstOsal\Projects #
#                          \zstack\Samples\SampleApp                          #
#                          com\CC2530DB\CoordinatorEB-Pro\Obj\search_zb_net.r #
#                          51                                                 #
#                                                                             #
#                                                                             #
###############################################################################

D:\WorkReserve\project\NewStep\CanMstOsal\Components\mac\low_level\srf04\search_zb_net.c
      1          /******************** (C) COPYRIGHT 2012 XXXXX Elec.,LTD ***********************
      2          * File Name         : search_zb_net.c
      3          * Author            : huangshengbin
      4          * Date First Issued : 
      5          * Description       : 用于扫描指定信道中网络列表
      6          ********************************************************************************
      7          * History:
      8          *******************************************************************************/
      9          
     10          #include "search_zb_net.h"
     11          
     12          
     13          #define DEBUG_SW       0
     14          #if  DEBUG_SW
     15          #include "utils.h"
     16          #define DEBUG_PRINTF(...)     kprintf(__VA_ARGS__)
     17          #else
     18          #define DEBUG_PRINTF(...)
     19          #endif
     20          
     21          
     22          
     23          typedef struct nwkParam
     24          {
     25            struct nwkParam *nextParam;
     26            uint8 logicalChannel;
     27            uint8 extendedPANID[8];
     28            uint16 PANID;
     29            uint16 chosenRouter;
     30            uint8 chosenRouterLinkQuality;
     31            uint8 chosenRouterDepth:4;
     32            uint8 routerCapacity:1;
     33            uint8 deviceCapacity:1;
     34          } DiscoveredNwkParam_t;
     35          
     36          #define CHANNELLIST_26    0x04000000  // 26 - 0x1A
     37          #define CHANNELLIST_25    0x02000000  // 25 - 0x19
     38          #define CHANNELLIST_24    0x01000000  // 24 - 0x18
     39          #define CHANNELLIST_23    0x00800000  // 23 - 0x17
     40          #define CHANNELLIST_22    0x00400000  // 22 - 0x16
     41          #define CHANNELLIST_21    0x00200000  // 21 - 0x15
     42          #define CHANNELLIST_20    0x00100000  // 20 - 0x14
     43          #define CHANNELLIST_19    0x00080000  // 19 - 0x13
     44          #define CHANNELLIST_18    0x00040000  // 18 - 0x12
     45          #define CHANNELLIST_17    0x00020000  // 17 - 0x11
     46          #define CHANNELLIST_16    0x00010000  // 16 - 0x10
     47          #define CHANNELLIST_15    0x00008000  // 15 - 0x0F
     48          #define CHANNELLIST_14    0x00004000  // 14 - 0x0E
     49          #define CHANNELLIST_13    0x00002000  // 13 - 0x0D
     50          #define CHANNELLIST_12    0x00001000  // 12 - 0x0C
     51          #define CHANNELLIST_11    0x00000800  // 11 - 0x0B
     52          
     53          //这里定义你想扫描的信道
     54          #define  testChannelList   (CHANNELLIST_11 | CHANNELLIST_12 | CHANNELLIST_23 | CHANNELLIST_24)
     55          
     56          //这里定义最大可保存的网络数量
     57          #define MAX_NWK_PARAMLIST        20
     58          DiscoveredNwkParam_t *pDiscoveredNwkParamList = NULL; //扫描结果保存在这里链表
     59          
     60          static uint8 gNwkCnt = 0; //记录扫描到的网络个数
     61          
     62          static void performNetworkDisc( uint32 scanChannelList );
     63          
     64          static void freeNwkParamList( void );
     65          
     66          static void *beaconIndCB ( void *param );
     67          
     68          static void *nwkDiscoveryCnfCB ( void *param );
     69          
     70          
     71          void scanNwkList(void)
     72          {
     73          	freeNwkParamList();
     74          	
     75            NLME_ResetRequest();
     76            
     77            performNetworkDisc(testChannelList);
     78          }
     79          
     80          
     81          void performNetworkDisc( uint32 scanChannelList )
     82          {
     83            NLME_ScanFields_t scan;
     84            
     85            devState = DEV_NWK_DISC;
     86          
     87            scan.channels = scanChannelList;
     88            scan.duration = BEACON_ORDER_240_MSEC;
     89            scan.scanType = ZMAC_ACTIVE_SCAN;
     90            scan.scanApp  = NLME_DISC_SCAN;
     91          
     92            if ( NLME_NwkDiscReq2( &scan ) == ZSuccess )
     93            {
     94              // Register ZDO callback to handle the network discovery confirm and
     95              // beacon notification confirm
     96              ZDO_RegisterForZdoCB( ZDO_NWK_DISCOVERY_CNF_CBID, nwkDiscoveryCnfCB );
                                           ^
Error[Pe020]: identifier "ZDO_NWK_DISCOVERY_CNF_CBID" is undefined
     97              ZDO_RegisterForZdoCB( ZDO_BEACON_NOTIFY_IND_CBID, beaconIndCB );
                                           ^
Error[Pe020]: identifier "ZDO_BEACON_NOTIFY_IND_CBID" is undefined
     98            }
     99            else
    100            {
    101              NLME_NwkDiscTerm();
    102            }
    103          }
    104          
    105          void *beaconIndCB ( void *param )
    106          {
    107            NLME_beaconInd_t *pBeacon = param;
                   ^
Error[Pe020]: identifier "NLME_beaconInd_t" is undefined

    NLME_beaconInd_t *pBeacon = param;
                      ^
"D:\WorkReserve\project\NewStep\CanMstOsal\Components\mac\low_level\srf04\search_zb_net.c",107  Error[Pe020]: 
          identifier "pBeacon" is undefined
    108            DiscoveredNwkParam_t *pParam = pDiscoveredNwkParamList;
    109            DiscoveredNwkParam_t *pLastParam;
    110            uint8 found = FALSE;
    111            
    112            if ( (pBeacon->permitJoining == TRUE) && 
    113            	 ((pBeacon->deviceCapacity || pBeacon->routerCapacity) || (pBeacon->LQI > gMIN_TREE_LINK_COST) ))
    114            {
    115              // Add the network parameter to the Network Parameter List
    116              while ( pParam != NULL )
    117              {
    118                if ( ( pParam->PANID == pBeacon->panID ) &&
    119                    ( pParam->logicalChannel == pBeacon->logicalChannel ))
    120                {
    121                  found = TRUE;
    122                  break;
    123                }
    124                
    125                pLastParam = pParam;
    126                pParam = pParam->nextParam;
    127              }
    128              
    129              // If no existing parameter found, make a new one and add to the list
    130              if ( found == FALSE )
    131              {
    132                gNwkCnt ++; 
    133                
    134                if (gNwkCnt > MAX_NWK_PARAMLIST)
    135                   return NULL;
    136                
    137                pParam = osal_mem_alloc( sizeof( DiscoveredNwkParam_t ) );
    138                if ( pParam == NULL )
    139                {
    140                  // Memory alloc failed, discard this beacon
    141                  return ( NULL );
    142                }
    143                
    144                // Clear the network descriptor
    145                osal_memset( pParam, 0, sizeof( DiscoveredNwkParam_t )  );
    146          
    147                // Initialize the descriptor
    148                pParam->chosenRouter = pBeacon->sourceAddr;
    149                pParam->chosenRouterLinkQuality = pBeacon->LQI;
    150                pParam->chosenRouterDepth = pBeacon->depth;
    151                
    152                // Save new entry into the descriptor list
    153                if ( pDiscoveredNwkParamList == NULL )
    154                {
    155                  // First element in the list
    156                  pDiscoveredNwkParamList = pParam;
    157                }
    158                else
    159                {
    160                  // Last element in the list
    161                  pLastParam->nextParam = pParam;
    162                }
    163              }
    164          
    165              // Update the descriptor with the incoming beacon
    166              pParam->logicalChannel = pBeacon->logicalChannel;
    167              pParam->PANID          = pBeacon->panID;
    168              
    169               // Save the extended PAN ID from the beacon payload only if 1.1 version network
    170              if ( pBeacon->protocolVersion != ZB_PROT_V1_0 )
    171              {
    172                osal_cpyExtAddr( pParam->extendedPANID, pBeacon->extendedPanID );
    173              }
    174              else
    175              {
    176                osal_memset( pParam->extendedPANID, 0xFF, Z_EXTADDR_LEN );
    177              }
    178          
    179              // check if this device is a better choice to join...
    180              // ...dont bother checking assocPermit flag is doing a rejoin
    181              if (  pBeacon->LQI > gMIN_TREE_LINK_COST  )
    182              {
    183                uint8 selected = FALSE;
    184                uint8 capacity = FALSE;
    185          
    186                if ( _NIB.nwkAddrAlloc == NWK_ADDRESSING_STOCHASTIC )
    187                {
    188                  if ( ((pBeacon->LQI   > pParam->chosenRouterLinkQuality) &&
    189                        (pBeacon->depth < MAX_NODE_DEPTH)) ||
    190                      ((pBeacon->LQI   == pParam->chosenRouterLinkQuality) &&
    191                       (pBeacon->depth < pParam->chosenRouterDepth)) )
    192                  {
    193                    selected = TRUE;
    194                  }
    195                }
    196                else
    197                {
    198                  if ( pBeacon->depth < pParam->chosenRouterDepth )
    199                  {
    200                    selected = TRUE;
    201                  }
    202                }
    203          
    204                capacity = pBeacon->routerCapacity;
    205          
    206                if ( (capacity) && (selected) )
    207                {
    208                  // this is the new chosen router for joining...
    209                  pParam->chosenRouter            = pBeacon->sourceAddr;
    210                  pParam->chosenRouterLinkQuality = pBeacon->LQI;
    211                  pParam->chosenRouterDepth       = pBeacon->depth;
    212                }
    213              }
    214            }
    215            return ( NULL );
    216          }
    217          
    218          void *nwkDiscoveryCnfCB ( void *param )
    219          {
    220            NLME_NwkDiscTerm();
    221            
    222            // Scan completed. De-register the callbacks with ZDO
    223            ZDO_DeregisterForZdoCB( ZDO_NWK_DISCOVERY_CNF_CBID );
                   ^
Error[Pe223]: function "ZDO_DeregisterForZdoCB" declared implicitly

    ZDO_DeregisterForZdoCB( ZDO_NWK_DISCOVERY_CNF_CBID );
                            ^
"D:\WorkReserve\project\NewStep\CanMstOsal\Components\mac\low_level\srf04\search_zb_net.c",223  Error[Pe020]: 
          identifier "ZDO_NWK_DISCOVERY_CNF_CBID" is undefined
    224            ZDO_DeregisterForZdoCB( ZDO_BEACON_NOTIFY_IND_CBID );
                   ^
Error[Pa045]: function "ZDO_DeregisterForZdoCB" has no prototype

    ZDO_DeregisterForZdoCB( ZDO_BEACON_NOTIFY_IND_CBID );
                            ^
"D:\WorkReserve\project\NewStep\CanMstOsal\Components\mac\low_level\srf04\search_zb_net.c",224  Error[Pe020]: 
          identifier "ZDO_BEACON_NOTIFY_IND_CBID" is undefined
    225            
    226            if ( pDiscoveredNwkParamList != NULL )
    227            {
    228              #warning 这里扫描到结果
                      ^
Warning[Pe1105]: #warning directive: 这里扫描到结果
    229            }
    230            else
    231            {
    232              #warning 这里扫描不到网络
                      ^
Warning[Pe1105]: #warning directive: 这里扫描不到网络
    233            }
    234            
    235            freeNwkParamList();
    236          
    237            return ( NULL );
    238          }
    239          
    240          void freeNwkParamList( void )
    241          {
    242            DiscoveredNwkParam_t *pParam = pDiscoveredNwkParamList;
    243            DiscoveredNwkParam_t *pNextParam;
    244          
    245            // deallocate the pDiscoveredNwkParamList memory
    246            while ( pParam != NULL )
    247            {
    248              pNextParam = pParam->nextParam;
    249          
    250              osal_mem_free( pParam );
    251          
    252              pParam = pNextParam;
    253            }
    254          
    255            pDiscoveredNwkParamList = NULL;
    256            gNwkCnt = 0;
    257          }

Errors: 8
Warnings: 2
