###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.4.40412/W32 for 8051         04/Dec/2016  22:37:57 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data                                               #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Components\simpli #
#                          citi\nwk_applications\nwk_join.c                   #
#    Command line       =  -f C:\Users\freeman\Documents\work\NBK\Nikon\Nikon #
#                          Stm32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examp #
#                          les\SRF05_8051\nik_sb5000\IAR\Configuration\LinkTo #
#                          \smpl_config.dat ("-DTHIS_DEVICE_ADDRESS={0x79,    #
#                          0x56, 0x34, 0x12}" -DxNWK_PLL_REFERENCE_CLOCK      #
#                          -DLINK_TO) -f C:\Users\freeman\Documents\work\NBK\ #
#                          Nikon\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Pro #
#                          jects\Examples\SRF05_8051\nik_sb5000\IAR\Configura #
#                          tion\smpl_nwk_config.dat (-DMAX_HOPS=3             #
#                          -DMAX_HOPS_FROM_AP=1 -DMAX_NWK_PAYLOAD=34          #
#                          -DMAX_APP_PAYLOAD=10 -DDEFAULT_LINK_TOKEN=0x010203 #
#                          04 -DDEFAULT_JOIN_TOKEN=0x05060708                 #
#                          -DxFREQUENCY_AGILITY -DxAPP_AUTO_ACK               #
#                          -DxEXTENDED_API -DxSMPL_SECURE                     #
#                          -DxNVOBJECT_SUPPORT -DxSW_TIMER                    #
#                          -DNUM_CONNECTIONS=2 -DSIZE_INFRAME_Q=4             #
#                          -DSIZE_OUTFRAME_Q=2 -DxFREQUENCY_HOPPING           #
#                          -DNWK_PLL_SHOW_LOCATION_INDICATORS                 #
#                          -DUART_NUMBER=UART_NUMBER_0                        #
#                          -DUART_LOCATION=UART_LOCATION_1                    #
#                          -DUART_BAUD_RATE=115200 -DUART_FLOW_CONTROL=UART_F #
#                          LOW_CONTROL_OFF -DUART_PARITY_MODE=UART_PARITY_NON #
#                          E -DUART_STOP_BITS=UART_1_STOP_BIT                 #
#                          -DBSP_TIMER_USED=1 -DEND_DEVICE)                   #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Components\simpli #
#                          citi\nwk_applications\nwk_join.c -D                #
#                          MCU_H=<ioCC2530.h> -D MRFI_CC2530 -D ZTOOL_P1 -lC  #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\LinkTo\List\ -lA        #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\LinkTo\List\ -o         #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\LinkTo\Obj\ -e --debug  #
#                          --core=plain --dptr=16,1 --data_model=large        #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data --nr_virtual_regs    #
#                          16 -I C:\Users\freeman\Documents\work\NBK\Nikon\Ni #
#                          konStm32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Ex #
#                          amples\SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Co #
#                          mponents\bsp\ -I C:\Users\freeman\Documents\work\N #
#                          BK\Nikon\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1.2.0\ #
#                          Projects\Examples\SRF05_8051\nik_sb5000\IAR\..\..\ #
#                          ..\..\..\Components\bsp\drivers\ -I                #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Componen #
#                          ts\bsp\boards\CC2530EM\ -I                         #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Componen #
#                          ts\mrfi\ -I C:\Users\freeman\Documents\work\NBK\Ni #
#                          kon\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Proje #
#                          cts\Examples\SRF05_8051\nik_sb5000\IAR\..\..\..\.. #
#                          \..\Components\SimpliciTI\nwk\ -I                  #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\Applications\  #
#                          -I C:\Users\freeman\Documents\work\NBK\Nikon\Nikon #
#                          Stm32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examp #
#                          les\SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Compo #
#                          nents\SimpliciTI\nwk_applications\ -I              #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Componen #
#                          ts\OSAL\INCLUDE\ -I C:\Users\freeman\Documents\wor #
#                          k\NBK\Nikon\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1.2 #
#                          .0\Projects\Examples\SRF05_8051\nik_sb5000\IAR\..\ #
#                          ..\..\..\..\Components\OSAL\MCU\CCSOC\ -I          #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Componen #
#                          ts\HAL\INCLUDE\ -I C:\Users\freeman\Documents\work #
#                          \NBK\Nikon\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1.2. #
#                          0\Projects\Examples\SRF05_8051\nik_sb5000\IAR\..\. #
#                          .\..\..\..\Components\HAL\TARGET\CC2530EB\ -I      #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Componen #
#                          ts\SERVICES\SADDR\ -I C:\Users\freeman\Documents\w #
#                          ork\NBK\Nikon\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1 #
#                          .2.0\Projects\Examples\SRF05_8051\nik_sb5000\IAR\. #
#                          .\..\..\..\..\Components\SERVICES\SDATA\ -I        #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Componen #
#                          ts\MT\ -I C:\Users\freeman\Documents\work\NBK\Niko #
#                          n\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Project #
#                          s\Examples\SRF05_8051\nik_sb5000\IAR\..\..\..\..\. #
#                          .\Components\STACK\AF\ -I                          #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Componen #
#                          ts\STACK\NWK\ -I C:\Users\freeman\Documents\work\N #
#                          BK\Nikon\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1.2.0\ #
#                          Projects\Examples\SRF05_8051\nik_sb5000\IAR\..\..\ #
#                          ..\..\..\Components\STACK\SEC\ -I                  #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Componen #
#                          ts\STACK\SAPI\ -I C:\Users\freeman\Documents\work\ #
#                          NBK\Nikon\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1.2.0 #
#                          \Projects\Examples\SRF05_8051\nik_sb5000\IAR\..\.. #
#                          \..\..\..\Components\STACK\SYS\ -I                 #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Componen #
#                          ts\STACK\ZDO\ -I C:\Users\freeman\Documents\work\N #
#                          BK\Nikon\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1.2.0\ #
#                          Projects\Examples\SRF05_8051\nik_sb5000\IAR\..\..\ #
#                          ..\..\..\Components\MAC\INCLUDE\ -I                #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Componen #
#                          ts\MAC\HIGH_LEVEL\ -I C:\Users\freeman\Documents\w #
#                          ork\NBK\Nikon\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1 #
#                          .2.0\Projects\Examples\SRF05_8051\nik_sb5000\IAR\. #
#                          .\..\..\..\..\Components\MAC\LOW_LEVEL\srf04\ -I   #
#                          C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\..\..\..\..\..\Componen #
#                          ts\MAC\LOW_LEVEL\srf04\SINGLE_CHIP\ -Ohz           #
#                          --require_prototypes                               #
#    List file          =  C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\LinkTo\List\nwk_join.ls #
#                          t                                                  #
#    Object file        =  C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm #
#                          32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Projects\Examples #
#                          \SRF05_8051\nik_sb5000\IAR\LinkTo\Obj\nwk_join.r51 #
#                                                                             #
#                                                                             #
###############################################################################

C:\Users\freeman\Documents\work\NBK\Nikon\NikonStm32\Nikon_Rf\SimpliciTI-IAR-1.2.0\Components\simpliciti\nwk_applications\nwk_join.c
      1          /**************************************************************************************************
      2            Filename:       nwk_join.c
      3            Revised:        $Date: 2009-01-06 15:45:54 -0800 (Tue, 06 Jan 2009) $
      4            Revision:       $Revision: 18697 $
      5          
      6            Description:    This file supports the SimpliciTI Join network application.
      7          
      8            Copyright 2007-2009 Texas Instruments Incorporated. All rights reserved.
      9          
     10            IMPORTANT: Your use of this Software is limited to those specific rights granted under
     11            the terms of a software license agreement between the user who downloaded the software,
     12            his/her employer (which must be your employer) and Texas Instruments Incorporated (the
     13            "License"). You may not use this Software unless you agree to abide by the terms of the
     14            License. The License limits your use, and you acknowledge, that the Software may not be
     15            modified, copied or distributed unless embedded on a Texas Instruments microcontroller
     16            or used solely and exclusively in conjunction with a Texas Instruments radio frequency
     17            transceiver, which is integrated into your product. Other than for the foregoing purpose,
     18            you may not use, reproduce, copy, prepare derivative works of, modify, distribute,
     19            perform, display or sell this Software and/or its documentation for any purpose.
     20          
     21            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE PROVIDED “AS IS”
     22            WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION, ANY
     23            WARRANTY OF MERCHANTABILITY, TITLE, NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE.
     24            IN NO EVENT SHALL TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     25            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER LEGAL EQUITABLE
     26            THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES INCLUDING BUT NOT LIMITED TO ANY
     27            INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST
     28            DATA, COST OF PROCUREMENT OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY
     29            THIRD PARTIES (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     30          
     31            Should you have any questions regarding your right to use this Software,
     32            contact Texas Instruments Incorporated at www.TI.com.
     33          **************************************************************************************************/
     34          
     35          
     36          /******************************************************************************
     37           * INCLUDES
     38           */
     39          #include <string.h>
     40          #include "bsp.h"
     41          #include "mrfi.h"
     42          #include "nwk_types.h"
     43          #include "nwk_api.h"
     44          #include "nwk_frame.h"
     45          #include "nwk.h"
     46          #include "nwk_link.h"
     47          #include "nwk_join.h"
     48          #include "nwk_globals.h"
     49          #include "nwk_freq.h"
     50          #include "nwk_security.h"
     51          #include "nwk_mgmt.h"
     52          
     53          /******************************************************************************
     54           * MACROS
     55           */
     56          
     57          /******************************************************************************
     58           * CONSTANTS AND DEFINES
     59           */
     60          
     61          /******************************************************************************
     62           * TYPEDEFS
     63           */
     64          
     65          /******************************************************************************
     66           * LOCAL VARIABLES
     67           */
     68          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     69          static          uint32_t sJoinToken = 0;
   \                     sJoinToken:
   \   000000                DS 4
   \   000004                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     70          static          uint8_t (*spCallback)(linkID_t) = NULL;
   \                     spCallback:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     71          static volatile uint8_t  sTid = 0;
   \                     sTid:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
     72          
     73          #ifdef ACCESS_POINT
     74          static sfInfo_t *spSandFContext = NULL;
     75          static uint8_t   sJoinOK = 0;
     76          #endif /* ACCESS_POINT */
     77          
     78          /******************************************************************************
     79           * LOCAL FUNCTIONS
     80           */
     81          #ifdef ACCESS_POINT
     82          static void     smpl_send_join_reply(mrfiPacket_t *frame);
     83          static uint32_t generateLinkToken(void);
     84          static void     handleJoinRequest(mrfiPacket_t *);
     85          #endif  /*  ACCESS_POINT */
     86          
     87          /******************************************************************************
     88           * GLOBAL VARIABLES
     89           */
     90          
     91          /******************************************************************************
     92           * GLOBAL FUNCTIONS
     93           */
     94          
     95          /******************************************************************************
     96           * @fn          nwk_joinInit
     97           *
     98           * @brief       Initialize Join application.
     99           *
    100           * input parameters
    101           *
    102           * output parameters
    103           *
    104           * @return   void
    105           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    106          void nwk_joinInit(uint8_t (*pf)(linkID_t))
   \                     nwk_joinInit:
    107          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
    108            if (!sJoinToken) 
   \   000009   90....       MOV     DPTR,#sJoinToken
   \   00000C   78..         MOV     R0,#?V0 + 0
   \   00000E   12....       LCALL   ?L_MOV_X
   \   000011   E5..         MOV     A,?V0 + 0
   \   000013   45..         ORL     A,?V0 + 1
   \   000015   45..         ORL     A,?V0 + 2
   \   000017   45..         ORL     A,?V0 + 3
   \   000019   700C         JNZ     ??nwk_joinInit_0
    109            {
    110              sJoinToken = DEFAULT_JOIN_TOKEN;
   \   00001B   90....       MOV     DPTR,#__Constant_5060708
   \   00001E   12....       LCALL   ?XLOAD_R2345
   \   000021   90....       MOV     DPTR,#sJoinToken
   \   000024   12....       LCALL   ?XSTORE_R2345
    111            }
    112            
    113            spCallback = pf;
   \                     ??nwk_joinInit_0:
   \   000027   90....       MOV     DPTR,#spCallback
   \   00002A   EE           MOV     A,R6
   \   00002B   F0           MOVX    @DPTR,A
   \   00002C   A3           INC     DPTR
   \   00002D   EF           MOV     A,R7
   \   00002E   F0           MOVX    @DPTR,A
    114            (void) spCallback;  /* keep compiler happy if we don't use this */
    115          
    116            sTid = MRFI_RandomByte() ;
   \   00002F                ; Setup parameters for call to function MRFI_RandomByte
   \   00002F   12....       LCALL   ??MRFI_RandomByte?relay
   \   000032   E9           MOV     A,R1
   \   000033   90....       MOV     DPTR,#sTid
   \   000036   F0           MOVX    @DPTR,A
    117          
    118          #ifdef ACCESS_POINT
    119            /* set link token to something other than deafult if desired */
    120            nwk_setLinkToken(generateLinkToken());
    121          #if defined(STARTUP_JOINCONTEXT_ON)
    122            sJoinOK = 1;
    123          #elif defined(STARTUP_JOINCONTEXT_OFF)
    124            sJoinOK = 0;
    125          #else
    126          #error ERROR: Must define either STARTUP_JOINCONTEXT_ON or STARTUP_JOINCONTEXT_OFF
    127          #endif
    128            spSandFContext = nwk_getSFInfoPtr();
    129          #endif
    130          
    131            return;
   \   000037                REQUIRE ?Subroutine0
   \   000037                ; // Fall through to label ?Subroutine0
    132          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   7F04         MOV     R7,#0x4
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA
    133          
    134          /******************************************************************************
    135           * @fn          nwk_setJoinToken
    136           *
    137           * @brief       Sets the join token.
    138           *
    139           * input parameters
    140           * @param   token   - join token to be used on this network.
    141           *
    142           * output parameters
    143           *         no room in output queue.
    144           *
    145           * @return   void
    146           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    147          void nwk_setJoinToken(uint32_t token)
   \                     nwk_setJoinToken:
    148          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   8B..         MOV     ?V0 + 1,R3
   \   000009   8C..         MOV     ?V0 + 2,R4
   \   00000B   8D..         MOV     ?V0 + 3,R5
    149            /* only set if the supplied token is non-zero. */
    150            if (token)
   \   00000D   EA           MOV     A,R2
   \   00000E   45..         ORL     A,?V0 + 1
   \   000010   45..         ORL     A,?V0 + 2
   \   000012   45..         ORL     A,?V0 + 3
   \   000014   6008         JZ      ??nwk_setJoinToken_0
    151            {
    152              sJoinToken = token;
   \   000016   90....       MOV     DPTR,#sJoinToken
   \   000019   78..         MOV     R0,#?V0 + 0
   \   00001B   12....       LCALL   ?L_MOV_TO_X
    153            }
    154          
    155            return;
   \                     ??nwk_setJoinToken_0:
   \   00001E   80..         SJMP    ?Subroutine0
    156          }
    157          
    158          /******************************************************************************
    159           * @fn          nwk_getJoinToken
    160           *
    161           * @brief       Gets the current join token.
    162           *
    163           * input parameters
    164           *
    165           * output parameters
    166           * @param   pToken   - pointer to the returned value.
    167           *
    168           * @return   Current link token
    169           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    170          void nwk_getJoinToken(uint32_t *pToken)
   \                     nwk_getJoinToken:
    171          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   F8           MOV     R0,A
   \   000007   EB           MOV     A,R3
   \   000008   F9           MOV     R1,A
    172            /* only set if the supplied token is non-zero. */
    173            if (pToken)
   \   000009   E8           MOV     A,R0
   \   00000A   49           ORL     A,R1
   \   00000B   600D         JZ      ??nwk_getJoinToken_0
    174            {
    175              *pToken = sJoinToken;
   \   00000D   90....       MOV     DPTR,#sJoinToken
   \   000010   12....       LCALL   ?XLOAD_R2345
   \   000013   8882         MOV     DPL,R0
   \   000015   8983         MOV     DPH,R1
   \   000017   12....       LCALL   ?XSTORE_R2345
    176            }
    177          
    178            return;
   \                     ??nwk_getJoinToken_0:
   \   00001A                REQUIRE ?Subroutine1
   \   00001A                ; // Fall through to label ?Subroutine1
    179          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine1:
   \   000000   7F01         MOV     R7,#0x1
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA
    180          
    181          /******************************************************************************
    182           * @fn          generateLinkToken
    183           *
    184           * @brief       Generate the link token to be used for the network controlled
    185           *              by this Access Point.
    186           *
    187           * input parameters
    188           *
    189           * output parameters
    190           *
    191           * @return   void
    192           */
    193          #ifdef ACCESS_POINT
    194          static uint32_t generateLinkToken(void)
    195          {
    196            return 0xDEADBEEF;
    197          }
    198          
    199          /******************************************************************************
    200           * @fn          smpl_send_join_reply
    201           *
    202           * @brief       Send the Join reply. Include the Link token. If the device is
    203           *              a polling sleeper put it into the list of store-and-forward
    204           *              clients.
    205           *
    206           * input parameters
    207           * @param   frame     - join frame for which a reply is needed...maybe
    208           *
    209           * output parameters
    210           *
    211           * @return   void
    212           */
    213          static void smpl_send_join_reply(mrfiPacket_t *frame)
    214          {
    215            frameInfo_t *pOutFrame;
    216            uint8_t      msg[JOIN_REPLY_FRAME_SIZE];
    217          
    218            /* Is this a legacy frame? If so continue. Otherwise check verion.*/
    219            if ((MRFI_GET_PAYLOAD_LEN(frame) - F_APP_PAYLOAD_OS) > JOIN_LEGACY_MSG_LENGTH)
    220            {
    221              /* see if protocol version is correct... */
    222              if (*(MRFI_P_PAYLOAD(frame)+F_APP_PAYLOAD_OS+J_PROTOCOL_VERSION_OS) != nwk_getProtocolVersion())
    223              {
    224                /* Accommodation of protocol version differences can be noted or accomplished here.
    225                 * Otherwise, no match and the board goes back
    226                 */
    227                return;
    228              }
    229            }
    230          
    231          
    232            /* see if join token is correct */
    233            {
    234              uint32_t jt;
    235          
    236              nwk_getNumObjectFromMsg(MRFI_P_PAYLOAD(frame)+F_APP_PAYLOAD_OS+J_JOIN_TOKEN_OS, &jt, sizeof(jt));
    237              if (jt != sJoinToken)
    238              {
    239                return;
    240              }
    241            }
    242          
    243            /* send reply with tid, the link token, and the encryption context */
    244            {
    245              uint32_t linkToken;
    246          
    247              nwk_getLinkToken(&linkToken);
    248              nwk_putNumObjectIntoMsg((void *)&linkToken, msg+JR_LINK_TOKEN_OS, sizeof(linkToken));
    249            }
    250            msg[JR_CRYPTKEY_SIZE_OS] = SEC_CRYPT_KEY_SIZE;
    251            msg[JB_REQ_OS]           = JOIN_REQ_JOIN | NWK_APP_REPLY_BIT;
    252            /* sender's tid... */
    253            msg[JB_TID_OS]           = *(MRFI_P_PAYLOAD(frame)+F_APP_PAYLOAD_OS+JB_TID_OS);
    254          
    255            if (pOutFrame = nwk_buildFrame(SMPL_PORT_JOIN, msg, sizeof(msg), MAX_HOPS_FROM_AP))
    256            {
    257              /* destination address is the source adddress of the received frame. */
    258              memcpy(MRFI_P_DST_ADDR(&pOutFrame->mrfiPkt), MRFI_P_SRC_ADDR(frame), NET_ADDR_SIZE);
    259          
    260          #ifdef AP_IS_DATA_HUB
    261              /* if source device supports ED objects save source address to detect duplicate joins */
    262              if (*(MRFI_P_PAYLOAD(frame)+F_APP_PAYLOAD_OS+J_NUMCONN_OS))
    263              {
    264                if (nwk_saveJoinedDevice(frame) && spCallback)
    265                {
    266                  spCallback(0);
    267                }
    268              }
    269          #endif
    270            }
    271            else
    272            {
    273              /* oops -- no room left for Tx frame. Don't send reply. */
    274              return;
    275            }
    276          
    277            /* If this device polls we need to provide store-and-forward support */
    278            if (GET_FROM_FRAME(MRFI_P_PAYLOAD(frame),F_RX_TYPE) == F_RX_TYPE_POLLS)
    279            {
    280              uint8_t loc;
    281          
    282              /* Check duplicate status */
    283              if (!nwk_isSandFClient(MRFI_P_SRC_ADDR(frame), &loc))
    284              {
    285                uint8_t        *pNumc   = &spSandFContext->curNumSFClients;
    286                sfClientInfo_t *pClient = &spSandFContext->sfClients[*pNumc];
    287          
    288                /* It's not a duplicate. Save it if there's room */
    289                if (*pNumc < NUM_STORE_AND_FWD_CLIENTS)
    290                {
    291                  memcpy(pClient->clientAddr.addr, MRFI_P_SRC_ADDR(frame), NET_ADDR_SIZE);
    292                  *pNumc = *pNumc + 1;
    293                }
    294                else
    295                {
    296                  /* No room left. Just return and don't send reply. */
    297                  return;
    298                }
    299              }
    300              else
    301              {
    302                /* We get here if it's a duplicate. We drop through and send reply.
    303                 * Reset the S&F marker in the Management application -- we should
    304                 * assume that the Client reset so the TID will be random. If this is
    305                 * simply a duplicate frame it causes no harm.
    306                 */
    307                nwk_resetSFMarker(loc);
    308              }
    309            }
    310          
    311          #ifdef SMPL_SECURE
    312              nwk_setSecureFrame(&pOutFrame->mrfiPkt, sizeof(msg), 0);
    313          #endif  /* SMPL_SECURE */
    314          
    315            /* It's not S&F or it is but we're OK to send reply. */
    316            nwk_sendFrame(pOutFrame, MRFI_TX_TYPE_FORCED);
    317          
    318            return;
    319          }
    320          
    321          /******************************************************************************
    322           * @fn          nwk_join
    323           *
    324           * @brief       Stub Join function for Access Points.
    325           *
    326           * input parameters
    327           *
    328           * output parameters
    329           *
    330           * @return   Always returns SMPL_SUCCESS.
    331           */
    332          smplStatus_t nwk_join(void)
    333          {
    334            return SMPL_SUCCESS;
    335          }
    336          
    337          /******************************************************************************
    338           * @fn          nwk_isSandFClient
    339           *
    340           * @brief       Helper function to see if the destination of a frame we have is
    341           *              one of AP's store-and-forward clients.
    342           *
    343           * input parameters
    344           * @param   fPtr     - pointer to address in frame in question
    345           *
    346           * output parameters
    347           * @param   entLoc   - pointer to receive entry location in array of clients.
    348           *
    349           * @return   Returns client info structure pointer if the destination is a
    350           *           store-and-forward client, else 0.
    351           */
    352          sfClientInfo_t *nwk_isSandFClient(uint8_t *pAddr, uint8_t *entLoc)
    353          {
    354            uint8_t i;
    355            sfClientInfo_t *pSFClient = spSandFContext->sfClients;
    356          
    357            for (i=0; i<spSandFContext->curNumSFClients; ++i, ++pSFClient)
    358            {
    359              if (!memcmp(&pSFClient->clientAddr.addr, pAddr, NET_ADDR_SIZE))
    360              {
    361                *entLoc = i;
    362                return pSFClient;
    363              }
    364            }
    365          
    366            return 0;
    367          }
    368          
    369          /******************************************************************************
    370           * @fn          nwk_setJoinContext
    371           *
    372           * @brief       Helper function to set Join context for Access Point. This will
    373           *              allow arbitration bewteen potentially nearby Access Points when
    374           *              a new device is joining.
    375           *
    376           * input parameters
    377           * @param   which   - Join context is either off or on
    378           *
    379           * output parameters
    380           *
    381           * @return   void
    382           */
    383          void nwk_setJoinContext(uint8_t which)
    384          {
    385            sJoinOK = (JOIN_CONTEXT_ON == which) ? 1 : 0;
    386          
    387            return;
    388          }
    389          
    390          /******************************************************************************
    391           * @fn          handleJoinRequest
    392           *
    393           * @brief       Dispatches handler for specfic join request
    394           *
    395           * input parameters
    396           *
    397           * @param   frame - Join frame received
    398           *
    399           * output parameters
    400           *
    401           * @return   void
    402           */
    403          static void handleJoinRequest(mrfiPacket_t *frame)
    404          {
    405            if (JOIN_LEGACY_MSG_LENGTH == (MRFI_GET_PAYLOAD_LEN(frame) - F_APP_PAYLOAD_OS))
    406            {
    407              /* Legacy frame. Spoof a join request */
    408              *(MRFI_P_PAYLOAD(frame)+F_APP_PAYLOAD_OS) = JOIN_REQ_JOIN;
    409            }
    410          
    411            switch (*(MRFI_P_PAYLOAD(frame)+F_APP_PAYLOAD_OS))
    412            {
    413              case JOIN_REQ_JOIN:
    414                smpl_send_join_reply(frame);
    415                break;
    416          
    417              default:
    418                break;
    419            }
    420          
    421            return;
    422          }
    423          
    424          #else  /* ACCESS_POINT */
    425          
    426          /******************************************************************************
    427           * @fn          nwk_join
    428           *
    429           * @brief       Join functioanlity for non-AP devices. Send the Join token
    430           *              and wait for the reply.
    431           *
    432           * input parameters
    433           *
    434           * output parameters
    435           *
    436           * @return   Status of operation.
    437           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    438          smplStatus_t nwk_join(void)
   \                     nwk_join:
    439          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 23
   \   000005   74E9         MOV     A,#-0x17
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
    440            uint8_t      msg[JOIN_FRAME_SIZE];
    441            uint32_t     linkToken;
    442            addr_t       apAddr;
    443            uint8_t      radioState = MRFI_GetRadioState();
   \   00000A                ; Setup parameters for call to function MRFI_GetRadioState
   \   00000A   12....       LCALL   ??MRFI_GetRadioState?relay
   \   00000D   E9           MOV     A,R1
   \   00000E   FF           MOV     R7,A
    444            smplStatus_t rc = SMPL_NO_JOIN;
   \   00000F   7E06         MOV     R6,#0x6
    445            union
    446            {
    447              ioctlRawSend_t    send;
    448              ioctlRawReceive_t recv;
    449            } ioctl_info;
    450          
    451          #if defined( FREQUENCY_AGILITY )
    452            uint8_t  i, numChan;
    453            freqEntry_t channels[NWK_FREQ_TBL_SIZE];
    454          
    455            if (!(numChan=nwk_scanForChannels(channels)))
    456            {
    457              return SMPL_NO_CHANNEL;
    458            }
    459          
    460            for (i=0; i<numChan; ++i)
    461            {
    462              nwk_setChannel(&channels[i]);
    463          #else
    464            {
    465          #endif
    466          
    467              ioctl_info.send.addr = (addr_t *)nwk_getBCastAddress();
   \   000011                ; Setup parameters for call to function nwk_getBCastAddress
   \   000011   12....       LCALL   ??nwk_getBCastAddress?relay
   \   000014   85..82       MOV     DPL,?XSP + 0
   \   000017   85..83       MOV     DPH,?XSP + 1
   \   00001A   EA           MOV     A,R2
   \   00001B   F0           MOVX    @DPTR,A
   \   00001C   A3           INC     DPTR
   \   00001D   EB           MOV     A,R3
   \   00001E   F0           MOVX    @DPTR,A
    468              ioctl_info.send.msg  = msg;
   \   00001F   7407         MOV     A,#0x7
   \   000021   12....       LCALL   ?XSTACK_DISP0_8
   \   000024   A882         MOV     R0,DPL
   \   000026   A983         MOV     R1,DPH
   \   000028   7402         MOV     A,#0x2
   \   00002A   12....       LCALL   ?XSTACK_DISP0_8
   \   00002D   E8           MOV     A,R0
   \   00002E   F0           MOVX    @DPTR,A
   \   00002F   A3           INC     DPTR
   \   000030   E9           MOV     A,R1
   \   000031   F0           MOVX    @DPTR,A
    469              ioctl_info.send.len  = sizeof(msg);
   \   000032   7404         MOV     A,#0x4
   \   000034   12....       LCALL   ?XSTACK_DISP0_8
   \   000037   7408         MOV     A,#0x8
   \   000039   F0           MOVX    @DPTR,A
    470              ioctl_info.send.port = SMPL_PORT_JOIN;
   \   00003A   7405         MOV     A,#0x5
   \   00003C   12....       LCALL   ?XSTACK_DISP0_8
   \   00003F   7403         MOV     A,#0x3
   \   000041   F0           MOVX    @DPTR,A
    471          
    472              /* Put join token in */
    473              nwk_putNumObjectIntoMsg((void *)&sJoinToken, msg+J_JOIN_TOKEN_OS, sizeof(sJoinToken));
   \   000042                ; Setup parameters for call to function nwk_putNumObjectIntoMsg
   \   000042   7904         MOV     R1,#0x4
   \   000044   7409         MOV     A,#0x9
   \   000046   12....       LCALL   ?XSTACK_DISP0_8
   \   000049   AC82         MOV     R4,DPL
   \   00004B   AD83         MOV     R5,DPH
   \   00004D   7A..         MOV     R2,#sJoinToken & 0xff
   \   00004F   7B..         MOV     R3,#(sJoinToken >> 8) & 0xff
   \   000051   12....       LCALL   ??nwk_putNumObjectIntoMsg?relay
    474              /* set app info byte */
    475              msg[JB_REQ_OS] = JOIN_REQ_JOIN;
   \   000054   7407         MOV     A,#0x7
   \   000056   12....       LCALL   ?XSTACK_DISP0_8
   \   000059   7401         MOV     A,#0x1
   \   00005B   F0           MOVX    @DPTR,A
    476              msg[JB_TID_OS] = sTid;
   \   00005C   90....       MOV     DPTR,#sTid
   \   00005F   E0           MOVX    A,@DPTR
   \   000060   C0E0         PUSH    A
   \   000062   7408         MOV     A,#0x8
   \   000064   12....       LCALL   ?XSTACK_DISP0_8
   \   000067   D0E0         POP     A
   \   000069   F0           MOVX    @DPTR,A
    477              /* Set number of connections supported. Used only by AP if it is
    478               * a data hub.
    479               */
    480              msg[J_NUMCONN_OS] = NUM_CONNECTIONS;
   \   00006A   740D         MOV     A,#0xd
   \   00006C   12....       LCALL   ?XSTACK_DISP0_8
   \   00006F   7402         MOV     A,#0x2
   \   000071   F0           MOVX    @DPTR,A
    481              /* protocol version number */
    482              msg[J_PROTOCOL_VERSION_OS] = nwk_getProtocolVersion();
   \   000072                ; Setup parameters for call to function nwk_getProtocolVersion
   \   000072   12....       LCALL   ??nwk_getProtocolVersion?relay
   \   000075   740E         MOV     A,#0xe
   \   000077   12....       LCALL   ?XSTACK_DISP0_8
   \   00007A   E9           MOV     A,R1
   \   00007B   F0           MOVX    @DPTR,A
    483          
    484              SMPL_Ioctl(IOCTL_OBJ_RAW_IO, IOCTL_ACT_WRITE, &ioctl_info.send);
   \   00007C                ; Setup parameters for call to function SMPL_Ioctl
   \   00007C   85..82       MOV     DPL,?XSP + 0
   \   00007F   85..83       MOV     DPH,?XSP + 1
   \   000082   AC82         MOV     R4,DPL
   \   000084   AD83         MOV     R5,DPH
   \   000086   7A03         MOV     R2,#0x3
   \   000088   7902         MOV     R1,#0x2
   \   00008A   12....       LCALL   ??SMPL_Ioctl?relay
    485          
    486              ioctl_info.recv.port = SMPL_PORT_JOIN;
   \   00008D   7405         MOV     A,#0x5
   \   00008F   12....       LCALL   ?XSTACK_DISP0_8
   \   000092   7403         MOV     A,#0x3
   \   000094   F0           MOVX    @DPTR,A
    487              ioctl_info.recv.msg  = msg;
   \   000095   7407         MOV     A,#0x7
   \   000097   12....       LCALL   ?XSTACK_DISP0_8
   \   00009A   A882         MOV     R0,DPL
   \   00009C   A983         MOV     R1,DPH
   \   00009E   7402         MOV     A,#0x2
   \   0000A0   12....       LCALL   ?XSTACK_DISP0_8
   \   0000A3   E8           MOV     A,R0
   \   0000A4   F0           MOVX    @DPTR,A
   \   0000A5   A3           INC     DPTR
   \   0000A6   E9           MOV     A,R1
   \   0000A7   F0           MOVX    @DPTR,A
    488              ioctl_info.recv.addr = &apAddr;    /* save AP address from reply */
   \   0000A8   740F         MOV     A,#0xf
   \   0000AA   12....       LCALL   ?XSTACK_DISP0_8
   \   0000AD   A882         MOV     R0,DPL
   \   0000AF   A983         MOV     R1,DPH
   \   0000B1   85..82       MOV     DPL,?XSP + 0
   \   0000B4   85..83       MOV     DPH,?XSP + 1
   \   0000B7   E8           MOV     A,R0
   \   0000B8   F0           MOVX    @DPTR,A
   \   0000B9   A3           INC     DPTR
   \   0000BA   E9           MOV     A,R1
   \   0000BB   F0           MOVX    @DPTR,A
    489          
    490              NWK_CHECK_FOR_SETRX(radioState);
   \   0000BC   7403         MOV     A,#0x3
   \   0000BE   6F           XRL     A,R7
   \   0000BF   600B         JZ      ??nwk_join_0
   \   0000C1   7401         MOV     A,#0x1
   \   0000C3   6F           XRL     A,R7
   \   0000C4   7003         JNZ     ??nwk_join_1
   \   0000C6                ; Setup parameters for call to function MRFI_WakeUp
   \   0000C6   12....       LCALL   ??MRFI_WakeUp?relay
   \                     ??nwk_join_1:
   \   0000C9                ; Setup parameters for call to function MRFI_RxOn
   \   0000C9   12....       LCALL   ??MRFI_RxOn?relay
    491              NWK_REPLY_DELAY();
   \                     ??nwk_join_0:
   \   0000CC                ; Setup parameters for call to function MRFI_ReplyDelay
   \   0000CC   12....       LCALL   ??MRFI_ReplyDelay?relay
    492              NWK_CHECK_FOR_RESTORE_STATE(radioState);
   \   0000CF   7403         MOV     A,#0x3
   \   0000D1   6F           XRL     A,R7
   \   0000D2   600D         JZ      ??nwk_join_2
   \   0000D4   7401         MOV     A,#0x1
   \   0000D6   6F           XRL     A,R7
   \   0000D7   7005         JNZ     ??nwk_join_3
   \   0000D9                ; Setup parameters for call to function MRFI_Sleep
   \   0000D9   12....       LCALL   ??MRFI_Sleep?relay
   \   0000DC   8003         SJMP    ??nwk_join_2
   \                     ??nwk_join_3:
   \   0000DE                ; Setup parameters for call to function MRFI_RxIdle
   \   0000DE   12....       LCALL   ??MRFI_RxIdle?relay
    493          
    494              if (SMPL_SUCCESS == SMPL_Ioctl(IOCTL_OBJ_RAW_IO, IOCTL_ACT_READ, &ioctl_info.recv))
   \                     ??nwk_join_2:
   \   0000E1                ; Setup parameters for call to function SMPL_Ioctl
   \   0000E1   85..82       MOV     DPL,?XSP + 0
   \   0000E4   85..83       MOV     DPH,?XSP + 1
   \   0000E7   AC82         MOV     R4,DPL
   \   0000E9   AD83         MOV     R5,DPH
   \   0000EB   7A02         MOV     R2,#0x2
   \   0000ED   7902         MOV     R1,#0x2
   \   0000EF   12....       LCALL   ??SMPL_Ioctl?relay
   \   0000F2   E9           MOV     A,R1
   \   0000F3   7056         JNZ     ??nwk_join_4
    495              {
    496                uint8_t firstByte = msg[JB_REQ_OS] & (~NWK_APP_REPLY_BIT);
   \   0000F5   7407         MOV     A,#0x7
   \   0000F7   12....       LCALL   ?XSTACK_DISP0_8
   \   0000FA   E0           MOVX    A,@DPTR
   \   0000FB   547F         ANL     A,#0x7f
   \   0000FD   F8           MOV     R0,A
    497          
    498                /* Sanity check for correct reply frame. Older version
    499                 * has the length instead of the request as the first byte.
    500                 */
    501                if ((firstByte == JOIN_REQ_JOIN) ||
    502                    (firstByte == JOIN_REPLY_LEGACY_MSG_LENGTH)
    503                   )
   \   0000FE   7401         MOV     A,#0x1
   \   000100   68           XRL     A,R0
   \   000101   6004         JZ      ??nwk_join_5
   \   000103   EE           MOV     A,R6
   \   000104   68           XRL     A,R0
   \   000105   7044         JNZ     ??nwk_join_4
    504                {
    505                  /* join reply returns link token */
    506                  memcpy(&linkToken, msg+JR_LINK_TOKEN_OS, sizeof(linkToken));
   \                     ??nwk_join_5:
   \   000107                ; Setup parameters for call to function memcpy
   \   000107   75..04       MOV     ?V0 + 0,#0x4
   \   00010A   75..00       MOV     ?V0 + 1,#0x0
   \   00010D   78..         MOV     R0,#?V0 + 0
   \   00010F   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000112   740B         MOV     A,#0xb
   \   000114   12....       LCALL   ?XSTACK_DISP0_8
   \   000117   AC82         MOV     R4,DPL
   \   000119   AD83         MOV     R5,DPH
   \   00011B   7415         MOV     A,#0x15
   \   00011D   12....       LCALL   ?XSTACK_DISP0_8
   \   000120   AA82         MOV     R2,DPL
   \   000122   AB83         MOV     R3,DPH
   \   000124   12....       LCALL   ??memcpy?relay
   \   000127   7402         MOV     A,#0x2
   \   000129   12....       LCALL   ?DEALLOC_XSTACK8
    507          
    508                  nwk_setLinkToken(linkToken);
   \   00012C                ; Setup parameters for call to function nwk_setLinkToken
   \   00012C   7413         MOV     A,#0x13
   \   00012E   12....       LCALL   ?XSTACK_DISP0_8
   \   000131   12....       LCALL   ?XLOAD_R2345
   \   000134   12....       LCALL   ??nwk_setLinkToken?relay
    509                  /* save AP address */
    510                  nwk_setAPAddress(&apAddr);
   \   000137                ; Setup parameters for call to function nwk_setAPAddress
   \   000137   740F         MOV     A,#0xf
   \   000139   12....       LCALL   ?XSTACK_DISP0_8
   \   00013C   AA82         MOV     R2,DPL
   \   00013E   AB83         MOV     R3,DPH
   \   000140   12....       LCALL   ??nwk_setAPAddress?relay
    511                  sTid++;   /* guard against duplicates */
   \   000143   90....       MOV     DPTR,#sTid
   \   000146   E0           MOVX    A,@DPTR
   \   000147   04           INC     A
   \   000148   F0           MOVX    @DPTR,A
    512                  rc = SMPL_SUCCESS;
   \   000149   7E00         MOV     R6,#0x0
    513          #if defined( FREQUENCY_AGILITY )
    514                  break;
    515          #endif
    516                }
    517              }
    518              /* TODO: process encryption stuff */
    519            }
    520          
    521            return rc;
   \                     ??nwk_join_4:
   \   00014B   EE           MOV     A,R6
   \   00014C   F9           MOV     R1,A
   \   00014D   7417         MOV     A,#0x17
   \   00014F   12....       LCALL   ?DEALLOC_XSTACK8
   \   000152   7F02         MOV     R7,#0x2
   \   000154   02....       LJMP    ?BANKED_LEAVE_XDATA
    522          
    523          }
    524          
    525          #endif /* ACCESS_POINT */
    526          
    527          /******************************************************************************
    528           * @fn          nwk_processJoin
    529           *
    530           * @brief       Processes a Join frame. If this is a reply let it go to the
    531           *              application. Otherwise generate and send the reply.
    532           *
    533           * input parameters
    534           * @param   frame     - Pointer to Join frame
    535           *
    536           * output parameters
    537           *
    538           * @return   Keep frame for application, release frame, or replay frame.
    539           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    540          fhStatus_t nwk_processJoin(mrfiPacket_t *frame)
   \                     nwk_processJoin:
    541          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
    542            fhStatus_t rc = FHS_RELEASE;
   \   000005   7E00         MOV     R6,#0x0
    543            uint8_t    replyType;
    544          
    545            /* Make sure this is a reply and see if we sent this. Validate the
    546             * packet for reception by client app.
    547             */
    548            if (SMPL_MY_REPLY == (replyType=nwk_isValidReply(frame, sTid, JB_REQ_OS, JB_TID_OS)))
   \   000007                ; Setup parameters for call to function nwk_isValidReply
   \   000007   7D01         MOV     R5,#0x1
   \   000009   7C00         MOV     R4,#0x0
   \   00000B   90....       MOV     DPTR,#sTid
   \   00000E   E0           MOVX    A,@DPTR
   \   00000F   F9           MOV     R1,A
   \   000010   12....       LCALL   ??nwk_isValidReply?relay
   \   000013   E9           MOV     A,R1
   \   000014   7004         JNZ     ??nwk_processJoin_0
    549            {
    550              /* It's a match and it's a reply. Validate the received packet by
    551               * returning a 1 so it can be received by the client app.
    552               */
    553              MRFI_PostKillSem();
   \   000016                ; Setup parameters for call to function MRFI_PostKillSem
   \   000016   12....       LCALL   ??MRFI_PostKillSem?relay
    554              rc = FHS_KEEP;
   \   000019   0E           INC     R6
    555            }
    556          #if defined(ACCESS_POINT)
    557            else if (SMPL_A_REPLY == replyType)
    558            {
    559              /* No match. If I'm not an ED this is a reply that should be passed on. */
    560              rc = FHS_REPLAY;
    561            }
    562            else
    563            {
    564              /* Send reply if we're an Access Point otherwise ignore the frame. */
    565              if ((SMPL_NOT_REPLY == replyType) && sJoinOK)
    566              {
    567                handleJoinRequest(frame);
    568              }
    569            }
    570          #elif defined(RANGE_EXTENDER)
    571            else
    572            {
    573              /* Either a reply that has to be replayed or a request that
    574               * also must be replayed.
    575               */
    576              rc = FHS_REPLAY;
    577            }
    578          #endif /* not END_DEVICE */
    579          
    580            (void) replyType;  /* keep compiler happy */
    581          
    582            return rc;
   \                     ??nwk_processJoin_0:
   \   00001A   EE           MOV     A,R6
   \   00001B   F9           MOV     R1,A
   \   00001C   02....       LJMP    ?Subroutine1 & 0xFFFF
    583          }

   \                                 In  segment XDATA_I, align 1, keep-with-next
   \                     __Constant_5060708:
   \   000000                DS 4
   \   000004                REQUIRE `?<Initializer for __Constant_5060708>`
   \   000004                REQUIRE __INIT_XDATA_I

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for __Constant_5060708>`:
   \   000000   08070605     DD 84281096

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??nwk_joinInit?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    nwk_joinInit

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??nwk_setJoinToken?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    nwk_setJoinToken

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??nwk_getJoinToken?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    nwk_getJoinToken

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??nwk_join?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    nwk_join

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??nwk_processJoin?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    nwk_processJoin

   Maximum stack usage in bytes:

     Function                     ISTACK PSTACK XSTACK
     --------                     ------ ------ ------
     nwk_getJoinToken                 0      0      9
     nwk_join                         1      0     35
       -> MRFI_GetRadioState          0      0     66
       -> nwk_getBCastAddress         0      0     66
       -> nwk_putNumObjectIntoMsg     0      0     66
       -> nwk_getProtocolVersion      0      0     66
       -> SMPL_Ioctl                  0      0     66
       -> MRFI_WakeUp                 0      0     66
       -> MRFI_RxOn                   0      0     66
       -> MRFI_ReplyDelay             0      0     66
       -> MRFI_Sleep                  0      0     66
       -> MRFI_RxIdle                 0      0     66
       -> SMPL_Ioctl                  0      0     66
       -> memcpy                      0      0     70
       -> nwk_setLinkToken            0      0     66
       -> nwk_setAPAddress            0      0     66
     nwk_joinInit                     0      0     12
       -> MRFI_RandomByte             0      0     24
     nwk_processJoin                  0      0      9
       -> nwk_isValidReply            0      0     18
       -> MRFI_PostKillSem            0      0     18
     nwk_setJoinToken                 0      0     12


   Segment part sizes:

     Function/Label                        Bytes
     --------------                        -----
     sJoinToken                               4
     spCallback                               2
     sTid                                     1
     nwk_joinInit                            55
     ?Subroutine0                             5
     nwk_setJoinToken                        32
     nwk_getJoinToken                        26
     ?Subroutine1                             5
     nwk_join                               343
     nwk_processJoin                         31
     __Constant_5060708                       4
     ?<Initializer for __Constant_5060708>    4
     ??nwk_joinInit?relay                     6
     ??nwk_setJoinToken?relay                 6
     ??nwk_getJoinToken?relay                 6
     ??nwk_join?relay                         6
     ??nwk_processJoin?relay                  6

 
 497 bytes in segment BANKED_CODE
  30 bytes in segment BANK_RELAYS
   4 bytes in segment XDATA_I
   4 bytes in segment XDATA_ID
   7 bytes in segment XDATA_Z
 
 527 bytes of CODE  memory (+ 4 bytes shared)
   7 bytes of XDATA memory (+ 4 bytes shared)

Errors: none
Warnings: none
